#!/bin/bash

# ============================================
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ Expo —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø–æ—Ä—Ç–∞
# ============================================

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

echo "üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ Expo –¥–ª—è 360AutoMVP..."
echo ""

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# ============================================
# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –ø–æ—Ä—Ç–∞ 8081
# ============================================

PORT=8081
ALTERNATIVE_PORT=8082

check_and_kill_port() {
  local port=$1
  if lsof -i :$port > /dev/null 2>&1; then
    echo -e "${YELLOW}‚ö†Ô∏è  –ü–æ—Ä—Ç $port –∑–∞–Ω—è—Ç. –û—Å–≤–æ–±–æ–∂–¥–∞—é...${NC}"
    local pid=$(lsof -ti:$port)
    if [ ! -z "$pid" ]; then
      kill -9 $pid 2>/dev/null || true
      sleep 1
      echo -e "${GREEN}‚úÖ –ü–æ—Ä—Ç $port –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω${NC}"
    fi
  else
    echo -e "${GREEN}‚úÖ –ü–æ—Ä—Ç $port —Å–≤–æ–±–æ–¥–µ–Ω${NC}"
  fi
}

# –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–æ—Ä—Ç 8081
check_and_kill_port $PORT

# ============================================
# 2. –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –∏ –∫—ç—à–∞
# ============================================

echo ""
echo "üßπ –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ Expo..."

# –û—á–∏—â–∞–µ–º –ø–∞–ø–∫–∏ Expo
if [ -d ".expo" ]; then
  rm -rf .expo
  echo "   ‚úÖ –£–¥–∞–ª–µ–Ω–∞ –ø–∞–ø–∫–∞ .expo"
fi

if [ -d ".expo-shared" ]; then
  rm -rf .expo-shared
  echo "   ‚úÖ –£–¥–∞–ª–µ–Ω–∞ –ø–∞–ø–∫–∞ .expo-shared"
fi

# –û—á–∏—â–∞–µ–º –∫—ç—à node_modules
if [ -d "node_modules/.cache" ]; then
  rm -rf node_modules/.cache
  echo "   ‚úÖ –û—á–∏—â–µ–Ω –∫—ç—à node_modules"
fi

# –û—á–∏—â–∞–µ–º Metro bundler –∫—ç—à
if [ -d "/tmp/metro-*" ]; then
  rm -rf /tmp/metro-* 2>/dev/null || true
  echo "   ‚úÖ –û—á–∏—â–µ–Ω –∫—ç—à Metro bundler"
fi

echo -e "${GREEN}‚úÖ –ö—ç—à –æ—á–∏—â–µ–Ω${NC}"

# ============================================
# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Ç–∏–ª–∏—Ç—ã kill-port (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
# ============================================

if ! command -v kill-port &> /dev/null; then
  echo ""
  echo -e "${YELLOW}üí° –£—Ç–∏–ª–∏—Ç–∞ kill-port –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)${NC}"
  echo "   –î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏: npm install -g kill-port"
fi

# ============================================
# 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
# ============================================

echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è..."

# –ó–∞–≥—Ä—É–∂–∞–µ–º .env —Ñ–∞–π–ª –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if [ -f ".env" ]; then
  echo "   ‚úÖ –§–∞–π–ª .env –Ω–∞–π–¥–µ–Ω"
  # –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏)
  set -a
  source .env 2>/dev/null || true
  set +a
  echo "   ‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env –∑–∞–≥—Ä—É–∂–µ–Ω—ã"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ EXPO_PUBLIC –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
EXPO_VARS=$(env | grep EXPO_PUBLIC || true)
if [ -z "$EXPO_VARS" ]; then
  echo -e "${YELLOW}‚ö†Ô∏è  EXPO_PUBLIC –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã${NC}"
  echo "   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª .env –∏–ª–∏ app.json"
else
  echo "   ‚úÖ EXPO_PUBLIC –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–∞–π–¥–µ–Ω—ã:"
  env | grep EXPO_PUBLIC | sed 's/^/      /'
fi

# ============================================
# 5. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ—Ä—Ç–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞
# ============================================

FINAL_PORT=$PORT

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–≤–æ–±–æ–¥–µ–Ω –ª–∏ –ø–æ—Ä—Ç 8081
if lsof -i :$PORT > /dev/null 2>&1; then
  echo ""
  echo -e "${YELLOW}‚ö†Ô∏è  –ü–æ—Ä—Ç $PORT –≤—Å—ë –µ—â—ë –∑–∞–Ω—è—Ç –ø–æ—Å–ª–µ –ø–æ–ø—ã—Ç–∫–∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è${NC}"
  echo -e "${YELLOW}   –ü–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å –Ω–∞ –ø–æ—Ä—Ç $ALTERNATIVE_PORT...${NC}"
  FINAL_PORT=$ALTERNATIVE_PORT
  
  # –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ—Ä—Ç —Ç–æ–∂–µ
  check_and_kill_port $ALTERNATIVE_PORT
else
  echo ""
  echo -e "${GREEN}‚úÖ –ü–æ—Ä—Ç $PORT —Å–≤–æ–±–æ–¥–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é${NC}"
fi

# ============================================
# 6. –ó–∞–ø—É—Å–∫ Expo
# ============================================

echo ""
echo -e "${GREEN}üöÄ –ó–∞–ø—É—Å–∫ Expo –Ω–∞ –ø–æ—Ä—Ç—É $FINAL_PORT...${NC}"
echo ""

# –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ—Ä—Ç –¥–ª—è Expo
export EXPO_DEV_SERVER_PORT=$FINAL_PORT

# –ó–∞–ø—É—Å–∫–∞–µ–º Expo —Å –æ—á–∏—Å—Ç–∫–æ–π –∫—ç—à–∞
npx expo start -c --port $FINAL_PORT

