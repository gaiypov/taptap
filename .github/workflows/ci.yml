name: CI Code Quality

on:
  push:
    branches: ["dev", "main"]
  pull_request:
    branches: ["dev", "main"]

jobs:
  lint-and-typecheck:
    name: Lint â€¢ TypeScript â€¢ Quality Gate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install Dependencies
        run: npm ci

      # ---------- ESLint FULL RESTRICTED MODE ----------
      - name: Run ESLint (All Files)
        id: eslint
        run: |
          echo "ğŸ” Running ESLint..."
          npm run lint:strict || npm run lint
        continue-on-error: false

      # ---------- TypeScript STRICT Build ----------
      - name: TypeScript Type Check
        id: typecheck
        run: |
          echo "ğŸ§  Checking TS Types..."
          npm run typecheck
        continue-on-error: false

      # ---------- Frontend Build Check ----------
      - name: Frontend Build Check
        id: frontend-build
        run: |
          echo "ğŸ—ï¸ Checking frontend build..."
          npm run build:check
        continue-on-error: false

      # ---------- Prettier Formatting ----------
      - name: Prettier Check
        run: |
          echo "ğŸ¨ Checking Prettier formatting..."
          npm run format:check 2>/dev/null || echo "âš ï¸ Prettier not configured or check failed (non-blocking)"
        continue-on-error: true

      # ---------- Backend Validation (TS/ESM) ----------
      - name: Backend TypeScript Check
        working-directory: backend
        run: |
          echo "ğŸ›  Backend TypeScript Check..."
          npx tsc --noEmit --pretty false
        continue-on-error: false

      - name: Backend Build Check
        working-directory: backend
        run: |
          echo "ğŸ—ï¸ Backend Build Check..."
          npm run build
        continue-on-error: false

      # ---------- Expo-specific sanity checks ----------
      - name: Check expo-router integrity
        run: |
          echo "ğŸ“± Validating expo-router..."
          npx expo lint --if-present || echo "âš ï¸ Expo lint completed with warnings"
        continue-on-error: true

      - name: Summary
        run: echo "ğŸš€ CI Passed Successfully"
