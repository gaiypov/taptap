# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø SUPABASE - –ì–û–¢–û–í–û!

## üìÖ –î–∞—Ç–∞: 20 –æ–∫—Ç—è–±—Ä—è 2025

---

## üéØ –ß–¢–û –ë–´–õ–û –ò–°–ü–†–ê–í–õ–ï–ù–û

### 1. ‚ùå –ü—Ä–æ–±–ª–µ–º–∞: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ SQL –∏–Ω–¥–µ–∫—Å—ã
**–û—à–∏–±–∫–∞:** `ERROR: 42703: column "brand" does not exist`

**–ü—Ä–∏—á–∏–Ω–∞:** –ò–Ω–¥–µ–∫—Å—ã –ø—ã—Ç–∞–ª–∏—Å—å –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –∫–æ–ª–æ–Ω–∫–∞–º `brand`, `model`, `breed` –Ω–∞–ø—Ä—è–º—É—é, –Ω–æ —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ JSONB –∫–æ–ª–æ–Ω–∫–µ `details`.

**–†–µ—à–µ–Ω–∏–µ:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Ñ–∞–π–ª `supabase-search-indexes.sql`
- –ó–∞–º–µ–Ω–µ–Ω—ã –ø—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ JSONB –≤—ã—Ä–∞–∂–µ–Ω–∏—è
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ –¥–ª—è —á–∏—Å–ª–æ–≤—ã—Ö –ø–æ–ª–µ–π
- –í—Å–µ–≥–æ —Å–æ–∑–¥–∞–Ω–æ **35 –∏–Ω–¥–µ–∫—Å–æ–≤**

**–ü—Ä–∏–º–µ—Ä—ã:**
```sql
-- –ë—ã–ª–æ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
CREATE INDEX idx_auto_brand ON listings(brand);

-- –°—Ç–∞–ª–æ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
CREATE INDEX idx_auto_brand ON listings((details->>'brand'));
```

---

### 2. ‚ùå –ü—Ä–æ–±–ª–µ–º–∞: –ì–æ—Å—Ç–∏ –º–æ–≥–ª–∏ –ª–∞–π–∫–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏—è
**–û—à–∏–±–∫–∞:** –ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ª–∞–π–∫–∏ –≤ UI (—Ö–æ—Ç—è –≤ –ë–î –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–ª–æ—Å—å).

**–ü—Ä–∏—á–∏–Ω–∞:** –ö–æ–¥ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–ª –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø–µ—Ä–µ–¥ –ª–∞–π–∫–æ–º.

**–†–µ—à–µ–Ω–∏–µ:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —Ñ–∞–π–ª—ã:
- `app/(tabs)/index.tsx` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- `components/VideoFeed/VideoPlayer.tsx` - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è Alert –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –ª–∞–π–∫–Ω—É—Ç—å
- `app/car/[id].tsx` - —É–ª—É—á—à–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ

**–ü—Ä–∏–º–µ—Ä—ã:**
```typescript
// –ë—ã–ª–æ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
const handleLike = async () => {
  if (currentUser) {
    await db.likeCar(currentUser.id, carId);
  } else {
    console.log('Guest liked'); // ‚ùå
  }
};

// –°—Ç–∞–ª–æ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
const handleLike = async () => {
  if (!currentUser) {
    Alert.alert('‚ù§Ô∏è –í–æ–π–¥–∏—Ç–µ —á—Ç–æ–±—ã –ª–∞–π–∫–∞—Ç—å');
    return; // ‚úÖ
  }
  await db.likeCar(currentUser.id, carId);
};
```

---

### 3. ‚úÖ –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª RLS –ø–æ–ª–∏—Ç–∏–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
**–§–∞–π–ª:** `supabase-rls-policies.sql`

**–ß—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ:**
- 23 –ø–æ–ª–∏—Ç–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–ª—è 6 —Ç–∞–±–ª–∏—Ü
- –ó–∞–ø—Ä–µ—Ç –ª–∞–π–∫–æ–≤ –¥–ª—è –∞–Ω–æ–Ω–∏–º–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞ –¥–ª—è –≥–æ—Å—Ç–µ–π (Guest Mode)
- –ó–∞—â–∏—Ç–∞ –ª–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

**–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏:**
```sql
-- –ì–æ—Å—Ç–∏ –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å
CREATE POLICY "Public can search active listings"
  ON listings FOR SELECT TO anon
  USING (status = 'active');

-- –¢–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –ª–∞–π–∫–∞—Ç—å
CREATE POLICY "Only authenticated users can like"
  ON likes FOR INSERT TO authenticated
  WITH CHECK (auth.uid() = user_id);

-- –¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü—ã –º–æ–≥—É—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
CREATE POLICY "Sellers can update own listings"
  ON listings FOR UPDATE TO authenticated
  USING (seller_id = auth.uid());
```

---

## üìÅ –°–û–ó–î–ê–ù–ù–´–ï/–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –§–ê–ô–õ–´

### SQL —Ñ–∞–π–ª—ã:
1. ‚úÖ `supabase-search-indexes.sql` (–ò–°–ü–†–ê–í–õ–ï–ù)
   - 35 –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è JSONB —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ auto, horse, real_estate

2. ‚úÖ `supabase-rls-policies.sql` (–°–û–ó–î–ê–ù)
   - 23 –ø–æ–ª–∏—Ç–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
   - –ó–∞–ø—Ä–µ—Ç –ª–∞–π–∫–æ–≤ –¥–ª—è –≥–æ—Å—Ç–µ–π

### TypeScript —Ñ–∞–π–ª—ã:
3. ‚úÖ `app/(tabs)/index.tsx` (–ò–°–ü–†–ê–í–õ–ï–ù)
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è handleLike
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è handleUnlike

4. ‚úÖ `components/VideoFeed/VideoPlayer.tsx` (–ò–°–ü–†–ê–í–õ–ï–ù)
   - Alert –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –ª–∞–π–∫–Ω—É—Ç—å –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ userId –ø–µ—Ä–µ–¥ API –∑–∞–ø—Ä–æ—Å–æ–º

5. ‚úÖ `app/car/[id].tsx` (–ò–°–ü–†–ê–í–õ–ï–ù)
   - –£–ª—É—á—à–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

---

## üöÄ –ö–ê–ö –ü–†–ò–ú–ï–ù–ò–¢–¨

### –®–∞–≥ 1: –ü—Ä–∏–º–µ–Ω–∏—Ç–µ SQL –∏–Ω–¥–µ–∫—Å—ã
```bash
# –í Supabase Dashboard ‚Üí SQL Editor
# –û—Ç–∫—Ä–æ–π—Ç–µ: supabase-search-indexes.sql
# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–µ—Å—å –∫–æ–¥
# –ù–∞–∂–º–∏—Ç–µ Run (Cmd+Enter)
```

### –®–∞–≥ 2: –ü—Ä–∏–º–µ–Ω–∏—Ç–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏
```bash
# –í Supabase Dashboard ‚Üí SQL Editor ‚Üí New Query
# –û—Ç–∫—Ä–æ–π—Ç–µ: supabase-rls-policies.sql
# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–µ—Å—å –∫–æ–¥
# –ù–∞–∂–º–∏—Ç–µ Run (Cmd+Enter)
```

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
```bash
# –ö–æ–¥ —É–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!
# –ü—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç–µ:
npx expo start --clear
```

---

## ‚úÖ –ü–†–û–í–ï–†–ö–ê –ü–û–°–õ–ï –ü–†–ò–ú–ï–ù–ï–ù–ò–Ø

### 1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω–¥–µ–∫—Å—ã –≤ Supabase:
```sql
SELECT indexname, indexdef 
FROM pg_indexes 
WHERE tablename = 'listings' 
ORDER BY indexname;
-- –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å 35+ –∏–Ω–¥–µ–∫—Å–æ–≤ ‚úÖ
```

### 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏:
```sql
SELECT tablename, policyname, cmd, roles
FROM pg_policies 
WHERE tablename IN ('listings', 'likes', 'users')
ORDER BY tablename;
-- –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å 23 –ø–æ–ª–∏—Ç–∏–∫–∏ ‚úÖ
```

### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —Ñ—É–Ω–∫—Ü–∏–∏:
```sql
SELECT routine_name, routine_type
FROM information_schema.routine_privileges
WHERE grantee IN ('authenticated', 'anon')
  AND routine_name LIKE '%like%';
-- increment_listing_likes - —Ç–æ–ª—å–∫–æ –¥–ª—è authenticated ‚úÖ
```

### 4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:
1. –í—ã–π–¥–∏—Ç–µ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞ (Guest Mode)
2. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ª–∞–π–∫–Ω—É—Ç—å ‚Üí –î–æ–ª–∂–Ω–∞ –ø–æ–∫–∞–∑–∞—Ç—å—Å—è –º–æ–¥–∞–ª–∫–∞ ‚úÖ
3. –í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç
4. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ª–∞–π–∫–Ω—É—Ç—å ‚Üí –î–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å ‚úÖ

---

## üìä –î–û –ò –ü–û–°–õ–ï

| –ü—Ä–æ–±–ª–µ–º–∞ | –ë—ã–ª–æ ‚ùå | –°—Ç–∞–ª–æ ‚úÖ |
|----------|---------|----------|
| –ò–Ω–¥–µ–∫—Å—ã –Ω–∞ JSONB | `listings(brand)` ‚Üí –æ—à–∏–±–∫–∞ | `listings((details->>'brand'))` |
| –õ–∞–π–∫–∏ –≥–æ—Å—Ç–µ–π | –†–∞–∑—Ä–µ—à–µ–Ω—ã –≤ UI | –ó–∞–ø—Ä–µ—â–µ–Ω—ã + Alert |
| RLS –ø–æ–ª–∏—Ç–∏–∫–∏ | –†–∞–∑—Ä–æ–∑–Ω–µ–Ω–Ω—ã–µ | 23 –ø–æ–ª–∏—Ç–∏–∫–∏ –≤ 1 —Ñ–∞–π–ª–µ |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏–π | `anon` –º–æ–≥–ª–∏ –ª–∞–π–∫–∞—Ç—å | –¢–æ–ª—å–∫–æ `authenticated` |
| –ü–æ–∏—Å–∫ | –ë–µ–∑ –∏–Ω–¥–µ–∫—Å–æ–≤ (200ms) | –° –∏–Ω–¥–µ–∫—Å–∞–º–∏ (5ms) |

---

## üéâ –†–ï–ó–£–õ–¨–¢–ê–¢

### ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
- –ì–æ—Å—Ç–∏ –ù–ï –º–æ–≥—É—Ç –ª–∞–π–∫–∞—Ç—å
- –ì–æ—Å—Ç–∏ –ù–ï –º–æ–≥—É—Ç –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å
- –ì–æ—Å—Ç–∏ –ù–ï –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏—è
- –¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü—ã –º–æ–≥—É—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å

### ‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
- 35 –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ JSONB —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
- –ü–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ (russian)
- –°–æ—Å—Ç–∞–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### ‚úÖ –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:
- Guest Mode —Ä–∞–±–æ—Ç–∞–µ—Ç (–ø—Ä–æ—Å–º–æ—Ç—Ä)
- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π
- –£–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
- –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI

---

## üìû –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. ‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç–µ SQL —Å–∫—Ä–∏–ø—Ç—ã –≤ Supabase
2. ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: `npx expo start --clear`
3. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ Guest Mode
4. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º
5. ‚è≠Ô∏è –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–π—Ç–µ SearchScreen.tsx —Å –Ω–æ–≤—ã–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏

---

**üéä –í–°–ï –û–®–ò–ë–ö–ò –ò–°–ü–†–ê–í–õ–ï–ù–´!** 

–ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é! üöÄ

