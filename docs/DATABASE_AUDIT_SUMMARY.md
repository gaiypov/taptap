# –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç –ø–æ –∞—É–¥–∏—Ç—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

**–î–∞—Ç–∞:** 2025-01-28  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ê—É–¥–∏—Ç –∑–∞–≤–µ—Ä—à–µ–Ω

---

## üìã –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

### 1. RLS-–ø–æ–ª–∏—Ç–∏–∫–∏ ‚úÖ

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ RLS –≤–∫–ª—é—á–µ–Ω –Ω–∞ –≤—Å–µ—Ö —Ü–µ–ª–µ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö
- ‚úÖ –ü–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è `user_consents` –∏ `consent_audit_log` —Å–æ–∑–¥–∞–Ω—ã
- ‚úÖ –ü–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è `listings`, `cars`, `chat_threads`, `chat_messages` –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- ‚úÖ –ö–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –ø–æ–ª–∏—Ç–∏–∫ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- ‚úÖ –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ä–æ–ª—å admin/—Å–µ—Ä–≤–∏—Å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `service_role` –∫–ª—é—á –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ: `backend/services/supabaseClient.ts` —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç `serviceSupabase` –¥–ª—è backend –æ–ø–µ—Ä–∞—Ü–∏–π

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å–µ –≤ –ø–æ—Ä—è–¥–∫–µ

---

### 2. –ò–Ω–¥–µ–∫—Å—ã ‚úÖ

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ `user_consents`: –∏–Ω–¥–µ–∫—Å –ø–æ `user_id`, unique –∏–Ω–¥–µ–∫—Å –Ω–∞ `(user_id, consent_type)`, –∏–Ω–¥–µ–∫—Å—ã –ø–æ `granted`/`revoked`/`accepted_at`
- ‚úÖ `consent_audit_log`: –∏–Ω–¥–µ–∫—Å—ã –ø–æ `user_id`, `action`, `created_at DESC`
- ‚úÖ `listings`: –º–Ω–æ–∂–µ—Å—Ç–≤–æ –∏–Ω–¥–µ–∫—Å–æ–≤ (search trgm, `seller_user_id`, `price`, `location`, `created_at`, `boosted`/`promoted` filter partial indexes)
- ‚úÖ `cars`: –∏–Ω–¥–µ–∫—Å—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç —Ç–∏–ø–∏—á–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- ‚úÖ `messages`: –∏–Ω–¥–µ–∫—Å –ø–æ `conversation_id`, `sender_id`, `created_at` –∏ —á–∞—Å—Ç–∏—á–Ω—ã–π –ø–æ `is_read = false`

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- ‚úÖ –î–ª—è RLS-–ø–æ–ª–∏—Ç–∏–∫, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏—Ö `auth.uid()` –≤ —É—Å–ª–æ–≤–∏—è—Ö, –∏–Ω–¥–µ–∫—Å –ø–æ `user_id` —É–∂–µ –µ—Å—Ç—å
- üìä –î–ª—è —á–∞—Å—Ç—ã—Ö –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ `created_at` –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–æ—Å—Ç–∞–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã `(user_id, created_at DESC)` –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å—ã –º–µ–¥–ª–µ–Ω–Ω—ã–µ

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–Ω–¥–µ–∫—Å—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–µ–π—Å—ã

---

### 3. –õ–æ–≥–∏ Postgres ‚úÖ

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ü–æ–ª—É—á–µ–Ω—ã –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ Postgres (—Ñ—Ä–∞–≥–º–µ–Ω—Ç 24 —á–∞—Å–∞)
- ‚úÖ –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è: –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è, –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è, checkpoints
- ‚úÖ –û—à–∏–±–æ–∫ —É—Ä–æ–≤–Ω—è ERROR/FATAL –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
- ‚úÖ –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –ø–æ RLS/permission denied –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- ‚ö†Ô∏è –ü–æ–ª—É—á–∏—Ç—å –ª–æ–≥–∏ edge-function –∑–∞ —Ç–æ—Ç –∂–µ –ø–µ—Ä–∏–æ–¥

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –õ–æ–≥–∏ Postgres –≤ –ø–æ—Ä—è–¥–∫–µ

---

## üîç –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ service_role

**–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**

1. ‚úÖ `backend/services/supabaseClient.ts`
   - –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç `serviceSupabase` —Å service_role
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è backend –æ–ø–µ—Ä–∞—Ü–∏–π

2. ‚úÖ `backend/src/api/v1/chat.ts`
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç **anon key + RLS** ‚úÖ
   - –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: "–ë–µ–∑ service_role_key ‚Ä¢ RLS-only ‚Ä¢ Realtime Ready"

3. ‚úÖ `backend/src/api/v1/listings.ts`
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç **anon key + RLS** ‚úÖ
   - –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: "RLS-only ‚Ä¢ No service_role ‚Ä¢ Race-condition free ‚Ä¢ Realtime Ready"

4. ‚úÖ `backend/src/api/v1/business.ts`
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `serviceSupabase` (service_role)
   - **–û–ø—Ä–∞–≤–¥–∞–Ω–æ:** –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –±–∏–∑–Ω–µ—Å-–∞–∫–∫–∞—É–Ω—Ç–∞–º–∏ —Ç—Ä–µ–±—É—é—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —á–ª–µ–Ω—Å—Ç–≤–∞ –≤ –∫–æ–º–∞–Ω–¥–µ

5. ‚úÖ `supabase/functions/cleanup-listings/index.ts`
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç service_role ‚úÖ
   - **–û–ø—Ä–∞–≤–¥–∞–Ω–æ:** edge function –Ω—É–∂–µ–Ω bypass RLS –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

**–í—ã–≤–æ–¥:** ‚úÖ Service_role –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ, —Ç–æ–ª—å–∫–æ —Ç–∞–º –≥–¥–µ –Ω—É–∂–Ω–æ

---

### –°–æ—Å—Ç–∞–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã

**–ê–Ω–∞–ª–∏–∑ —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:**

1. **Chat Messages** (`thread_id` + `created_at`)
   - –ó–∞–ø—Ä–æ—Å: `SELECT * FROM chat_messages WHERE thread_id = $1 ORDER BY created_at DESC`
   - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: **–í–´–°–û–ö–ò–ô** (—á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
   - –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å `idx_chat_messages_thread_created`

2. **Chat Threads** (`buyer_id`/`seller_id` + `last_message_at`)
   - –ó–∞–ø—Ä–æ—Å: `SELECT * FROM chat_threads WHERE buyer_id = $1 ORDER BY last_message_at DESC`
   - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: **–°–†–ï–î–ù–ò–ô** (–¥–æ–±–∞–≤–∏—Ç—å –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å—ã –º–µ–¥–ª–µ–Ω–Ω—ã–µ)
   - –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

3. **Listings** (`seller_id` + `created_at`)
   - –ó–∞–ø—Ä–æ—Å: `SELECT * FROM listings WHERE seller_id = $1 ORDER BY created_at DESC`
   - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: **–°–†–ï–î–ù–ò–ô** (–¥–æ–±–∞–≤–∏—Ç—å –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å—ã –º–µ–¥–ª–µ–Ω–Ω—ã–µ)
   - –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

4. **Listing Likes/Saves** (`user_id` + `created_at`)
   - –ó–∞–ø—Ä–æ—Å: `SELECT * FROM listing_likes WHERE user_id = $1 ORDER BY created_at DESC`
   - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: **–°–†–ï–î–ù–ò–ô** (–¥–æ–±–∞–≤–∏—Ç—å –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å—ã –º–µ–¥–ª–µ–Ω–Ω—ã–µ)
   - –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

**–í—ã–≤–æ–¥:** üìä –°–æ–∑–¥–∞–Ω–∞ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è `20250128_composite_indexes_optional.sql` –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

---

## üìù –°–æ–∑–¥–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

1. ‚úÖ `docs/DATABASE_OPTIMIZATION_RECOMMENDATIONS.md`
   - –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ service_role
   - –ê–Ω–∞–ª–∏–∑ —Å–æ—Å—Ç–∞–≤–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤
   - –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ª–æ–≥–∞–º Edge Functions

2. ‚úÖ `supabase/migrations/20250128_composite_indexes_optional.sql`
   - –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è —Å–æ—Å—Ç–∞–≤–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤
   - –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏
   - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥—É

---

## ‚úÖ –ò—Ç–æ–≥–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è

1. ‚úÖ **RLS-–ø–æ–ª–∏—Ç–∏–∫–∏** - –≤—Å–µ –≤ –ø–æ—Ä—è–¥–∫–µ, –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –Ω–µ—Ç
2. ‚úÖ **–ò–Ω–¥–µ–∫—Å—ã** - –ø–æ–∫—Ä—ã–≤–∞—é—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–µ–π—Å—ã, –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è –±–µ–∑ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
3. ‚ö†Ô∏è **–õ–æ–≥–∏ Edge Functions** - –ø–æ–ª—É—á–∏—Ç—å –ª–æ–≥–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞

### –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

1. üìä **–°–æ—Å—Ç–∞–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã:**
   - –î–æ–±–∞–≤–∏—Ç—å `idx_chat_messages_thread_created` (–≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
   - –û—Å—Ç–∞–ª—å–Ω—ã–µ –¥–æ–±–∞–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

2. üìà **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
   - –í–∫–ª—é—á–∏—Ç—å `pg_stat_statements` –≤ Supabase
   - –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (>100ms)
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –Ω–∞ –æ—à–∏–±–∫–∏ Edge Functions

---

## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:** ‚úÖ –û—Ç–ª–∏—á–Ω–æ

- RLS-–ø–æ–ª–∏—Ç–∏–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- –ò–Ω–¥–µ–∫—Å—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–µ–π—Å—ã
- Service_role –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –õ–æ–≥–∏ Postgres –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –æ—à–∏–±–æ–∫

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**
1. –ü–æ–ª—É—á–∏—Ç—å –ª–æ–≥–∏ Edge Functions
2. –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤
3. –î–æ–±–∞–≤–ª—è—Ç—å —Å–æ—Å—Ç–∞–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

---

**–î–æ–∫—É–º–µ–Ω—Ç—ã:**
- üìÑ `docs/DATABASE_OPTIMIZATION_RECOMMENDATIONS.md` - –¥–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
- üìÑ `supabase/migrations/20250128_composite_indexes_optional.sql` - –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã

