# ๐ ะััั ะฟะพะปัะทะพะฒะฐัะตะปั ะธ ะฟัะพะฒะตัะบะธ ะฒ ะฟัะธะปะพะถะตะฝะธะธ

## ๐ฑ ะะพะปะฝัะน ะฟััั ะฟะพะปัะทะพะฒะฐัะตะปั ะพั ัััะฐะฝะพะฒะบะธ

### 1. **ะฃััะฐะฝะพะฒะบะฐ ะฟัะธะปะพะถะตะฝะธั**
- ะะพะปัะทะพะฒะฐัะตะปั ัััะฐะฝะฐะฒะปะธะฒะฐะตั ะฟัะธะปะพะถะตะฝะธะต ะธะท App Store/Google Play

### 2. **ะะตัะฒัะน ะทะฐะฟััะบ โ Splash Screen** (`app/splash.tsx`)
- ะะพะบะฐะทัะฒะฐะตััั ะปะพะณะพัะธะฟ 360Auto ั ะฐะฝะธะผะฐัะธะตะน
- **ะัะพะฒะตัััััั 3 ะฒะตัะธ:**

#### โ ะัะพะฒะตัะบะฐ 1: ะขะพะบะตะฝ ะฐะฒัะพัะธะทะฐัะธะธ
```typescript
const token = await storageService.getAuthToken();
```
- **ะะดะต ััะฐะฝะธััั:** `AsyncStorage` ั ะบะปััะพะผ `@auth_token`
- **ะงัะพ ะฟัะพะฒะตััะตััั:** ะััั ะปะธ ัะพััะฐะฝะตะฝะฝัะน JWT ัะพะบะตะฝ ะพั ะฟัะตะดัะดััะตะน ะฐะฒัะพัะธะทะฐัะธะธ
- **ะคะฐะนะป:** `services/storage.ts` โ ะผะตัะพะด `getAuthToken()`
- **ะะพะทะฒัะฐัะฐะตั:** `string | null` โ ัะพะบะตะฝ ะธะปะธ `null` ะตัะปะธ ะฝะตั

#### โ ะัะพะฒะตัะบะฐ 2: ะะฐะฝะฝัะต ะฟะพะปัะทะพะฒะฐัะตะปั
```typescript
const user = await storageService.getUserData();
```
- **ะะดะต ััะฐะฝะธััั:** `AsyncStorage` ั ะบะปััะพะผ `@user_data` (JSON)
- **ะงัะพ ะฟัะพะฒะตััะตััั:** ะััั ะปะธ ัะพััะฐะฝะตะฝะฝัะต ะดะฐะฝะฝัะต ะฟะพะปัะทะพะฒะฐัะตะปั (id, phone, name, avatar_url, etc.)
- **ะคะฐะนะป:** `services/storage.ts` โ ะผะตัะพะด `getUserData()`
- **ะะพะทะฒัะฐัะฐะตั:** `object | null` โ ะพะฑัะตะบั ั ะดะฐะฝะฝัะผะธ ะฟะพะปัะทะพะฒะฐัะตะปั ะธะปะธ `null`

**ะกัััะบัััะฐ ะดะฐะฝะฝัั ะฟะพะปัะทะพะฒะฐัะตะปั:**
```typescript
{
  id: string;
  phone: string;
  name: string;
  avatar_url: string;
  is_verified: boolean;
  created_at: string;
}
```

#### โ ะัะพะฒะตัะบะฐ 3: ะะฝะฑะพัะดะธะฝะณ ะฟัะพะนะดะตะฝ
```typescript
const onboardingCompleted = await AsyncStorage.getItem('onboarding_completed');
```
- **ะะดะต ััะฐะฝะธััั:** `AsyncStorage` ั ะบะปััะพะผ `onboarding_completed`
- **ะงัะพ ะฟัะพะฒะตััะตััั:** ะัะพัะตะป ะปะธ ะฟะพะปัะทะพะฒะฐัะตะปั ะพะฝะฑะพัะดะธะฝะณ (ะฟะพะบะฐะท ัะปะฐะนะดะพะฒ ะฟัะธ ะฟะตัะฒะพะผ ะทะฐะฟััะบะต)
- **ะะพะทะฒัะฐัะฐะตั:** `'true'` ะธะปะธ `null`
- **ะฃััะฐะฝะฐะฒะปะธะฒะฐะตััั ะฒ:** `app/(onboarding)/welcome.tsx`, `app/(onboarding)/permissions.tsx`

### 3. **ะะฐะฒะธะณะฐัะธั ะฟะพัะปะต Splash**

#### ะะฐัะธะฐะฝั A: ะะตัะฒัะน ะทะฐะฟััะบ (ะฝะตั ะพะฝะฑะพัะดะธะฝะณะฐ)
```
Splash โ (onboarding)/welcome โ (onboarding)/permissions โ (auth)/phone
```
- ะัะปะธ `onboardingCompleted !== 'true'` โ ะธะดะตะผ ะฝะฐ ะพะฝะฑะพัะดะธะฝะณ

#### ะะฐัะธะฐะฝั B: ะะฝะฑะพัะดะธะฝะณ ะฟัะพะนะดะตะฝ, ะฝะพ ะฝะต ะฐะฒัะพัะธะทะพะฒะฐะฝ
```
Splash โ (auth)/phone โ (auth)/verify โ (tabs)
```
- ะัะปะธ `onboardingCompleted === 'true'` ะฝะพ `!token || !user` โ ะธะดะตะผ ะฝะฐ ะฐะฒัะพัะธะทะฐัะธั

#### ะะฐัะธะฐะฝั C: ะฃะถะต ะฐะฒัะพัะธะทะพะฒะฐะฝ
```
Splash โ (tabs) โ ConsentModal (ะตัะปะธ ะฝะตั ัะพะณะปะฐัะธะน)
```
- ะัะปะธ `token && user` โ ะธะดะตะผ ััะฐะทั ะฒ ะฟัะธะปะพะถะตะฝะธะต
- ะะพัะปะต ะฒัะพะดะฐ ะฒ `(tabs)` ะฟัะพะฒะตัััััั ัะพะณะปะฐัะธั

### 4. **ConsentModal โ ะบะพะณะดะฐ ะฟะพะบะฐะทัะฒะฐะตััั**

**ะัะฟัะฐะฒะปะตะฝะฝะฐั ะปะพะณะธะบะฐ (ะฟะพัะปะต ัะธะบัะฐ):**

ConsentModal ะฟะพะบะฐะทัะฒะฐะตััั **ะขะะะฌะะ** ะบะพะณะดะฐ:
1. โ ะะพะปัะทะพะฒะฐัะตะปั ะฐะฒัะพัะธะทะพะฒะฐะฝ (`userId` ัััะตััะฒัะตั)
2. โ ะะฐะฒะธะณะฐัะธั ะฟะพะปะฝะพัััั ะธะฝะธัะธะฐะปะธะทะธัะพะฒะฐะฝะฐ (`isReady === true`)
3. โ ะะพะปัะทะพะฒะฐัะตะปั ะฝะฐัะพะดะธััั **ะฒ ะฟัะธะปะพะถะตะฝะธะธ** (`segments[0] === '(tabs)'`)
4. โ ะะพะปัะทะพะฒะฐัะตะปั **ะะ** ะฝะฐ auth/onboarding/splash ัะบัะฐะฝะฐั
5. โ API ะฒะพะทะฒัะฐัะฐะตั `hasConsents: false` (ะธะปะธ ะพัะธะฑะบะฐ/ัะฐะนะผะฐัั)

**ะะพะด ะฟัะพะฒะตัะบะธ:**
```typescript
// app/_layout.tsx, ัััะพะบะธ 254-338
useEffect(() => {
  if (!userId || !isReady || authLoading) return;
  
  const inAuthGroup = segments[0] === '(auth)';
  const inOnboardingGroup = segments[0] === '(onboarding)';
  const isSplash = segments[0] === 'splash' || segments.length === 0;
  const inTabsGroup = segments[0] === '(tabs)';
  
  // ะะพะบะฐะทัะฒะฐะตะผ ConsentModal ัะพะปัะบะพ ะบะพะณะดะฐ ะฟะพะปัะทะพะฒะฐัะตะปั ัะถะต ะฒ ะฟัะธะปะพะถะตะฝะธะธ
  if (!inTabsGroup || inAuthGroup || inOnboardingGroup || isSplash) {
    if (showConsent) setShowConsent(false);
    return;
  }
  
  // ะัะพะฒะตััะตะผ ัะพะณะปะฐัะธั ัะตัะตะท API
  const hasConsent = await api.consents.getStatus();
  if (!hasConsent) {
    setShowConsent(true);
  }
}, [userId, isReady, authLoading, segments]);
```

## ๐ง ะงัะพ ะฑัะปะพ ะธัะฟัะฐะฒะปะตะฝะพ

### ะัะพะฑะปะตะผะฐ 1: ConsentModal ะฟะพะบะฐะทัะฒะฐะปัั ัะปะธัะบะพะผ ัะฐะฝะพ
**ะัะปะพ:** ะะพะบะฐะทัะฒะฐะปัั ััะฐะทั ะฟะพัะปะต ะธะฝะธัะธะฐะปะธะทะฐัะธะธ, ะดะพ ัะพะณะพ ะบะฐะบ ะฝะฐะฒะธะณะฐัะธั ะณะพัะพะฒะฐ  
**ะกัะฐะปะพ:** ะะพะบะฐะทัะฒะฐะตััั ัะพะปัะบะพ ะบะพะณะดะฐ ะฟะพะปัะทะพะฒะฐัะตะปั ัะถะต ะฒ `(tabs)` ะธ ะฝะฐะฒะธะณะฐัะธั ะณะพัะพะฒะฐ

### ะัะพะฑะปะตะผะฐ 2: ะะพะฝัะปะธะบั ั ะฝะฐะฒะธะณะฐัะธะตะน
**ะัะปะพ:** Modal ะฟะพะบะฐะทัะฒะฐะปัั ะฟะพะฒะตัั auth/onboarding ัะบัะฐะฝะพะฒ, ะฒัะทัะฒะฐั ะบัะฐัะธ  
**ะกัะฐะปะพ:** Modal ะฟะพะบะฐะทัะฒะฐะตััั ัะพะปัะบะพ ะฝะฐ ัะบัะฐะฝะฐั ะฟัะธะปะพะถะตะฝะธั (`(tabs)`)

### ะัะพะฑะปะตะผะฐ 3: ะะฝะพะถะตััะฒะตะฝะฝัะต ะฟัะพะฒะตัะบะธ
**ะัะปะพ:** ะัะพะฒะตัะบะฐ ัะพะณะปะฐัะธะน ะฒัะฟะพะปะฝัะปะฐัั ะฟัะธ ะบะฐะถะดะพะน ะธะฝะธัะธะฐะปะธะทะฐัะธะธ  
**ะกัะฐะปะพ:** ะัะฟะพะปัะทัะตััั `consentCheckDone.current` ref ะดะปั ะฟัะพะฒะตัะบะธ ัะพะปัะบะพ ะพะดะธะฝ ัะฐะท

## ๐ ะกัะตะผะฐ ะฟัะพะฒะตัะพะบ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ         Splash Screen                   โ
โ  ะัะพะฒะตััะตั: token, user, onboarding    โ
โโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโ
               โ
       โโโโโโโโโดโโโโโโโโ
       โ               โ
   โโโโโผโโโโ      โโโโโโผโโโโโ
   โ Onboarding โ  โ  Auth   โ
   โโโโโโโโฌโโโโโโโ  โโโโโโฌโโโโโ
          โ              โ
          โโโโโโโโฌโโโโโโโโ
                 โ
          โโโโโโโโผโโโโโโโ
          โ   (tabs)    โ
          โ  ะัะธะปะพะถะตะฝะธะต โ
          โโโโโโโโฌโโโโโโโ
                 โ
          โโโโโโโโผโโโโโโโโโโโ
          โ ะัะพะฒะตัะบะฐ ัะพะณะปะฐัะธะนโ
          โ  (ConsentModal)  โ
          โโโโโโโโโโโโโโโโโโโโ
```

## ๐ฏ ะัะพะณะพะฒะฐั ะปะพะณะธะบะฐ

1. **Splash** ะฟัะพะฒะตััะตั ัะพะบะตะฝ, ะฟะพะปัะทะพะฒะฐัะตะปั, ะพะฝะฑะพัะดะธะฝะณ
2. **ะะฐะฒะธะณะฐัะธั** ะฟัะพะธััะพะดะธั ะฒ ะทะฐะฒะธัะธะผะพััะธ ะพั ัะตะทัะปััะฐัะพะฒ ะฟัะพะฒะตัะพะบ
3. **ConsentModal** ะฟะพะบะฐะทัะฒะฐะตััั ัะพะปัะบะพ ะบะพะณะดะฐ:
   - ะะพะปัะทะพะฒะฐัะตะปั ะฐะฒัะพัะธะทะพะฒะฐะฝ
   - ะะพะปัะทะพะฒะฐัะตะปั ะฒ ะฟัะธะปะพะถะตะฝะธะธ (tabs)
   - ะะตั ัะพะณะปะฐัะธะน ะฒ ะฑะฐะทะต ะดะฐะฝะฝัั

## ๐ ะคะฐะนะปั, ะณะดะต ะฟัะพะธััะพะดัั ะฟัะพะฒะตัะบะธ

- **Splash ะฟัะพะฒะตัะบะธ:** `app/splash.tsx` (ัััะพะบะธ 125-135)
- **Storage ะผะตัะพะดั:** `services/storage.ts`
  - `getAuthToken()` โ ะฟะพะปััะตะฝะธะต ัะพะบะตะฝะฐ
  - `getUserData()` โ ะฟะพะปััะตะฝะธะต ะดะฐะฝะฝัั ะฟะพะปัะทะพะฒะฐัะตะปั
- **ConsentModal ะปะพะณะธะบะฐ:** `app/_layout.tsx` (ัััะพะบะธ 254-338)
- **ConsentModal UI:** `components/Legal/ConsentModal.tsx`

