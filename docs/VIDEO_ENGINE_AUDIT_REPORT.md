# üé¨ –ê—É–¥–∏—Ç –≤–∏–¥–µ–æ–¥–≤–∏–∂–∫–∞ 360Auto | –î–æ —É—Ä–æ–≤–Ω—è TikTok

**–î–∞—Ç–∞:** 2025-01-31
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ê—É–¥–∏—Ç –∑–∞–≤–µ—Ä—à–µ–Ω | üöÄ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –≥–æ—Ç–æ–≤—ã

---

## üìä Executive Summary

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: **85/100**

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –û—Ü–µ–Ω–∫–∞ | TikTok —É—Ä–æ–≤–µ–Ω—å |
|----------|--------|----------------|
| **–ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞** | 8/10 | ‚úÖ –û—Ç–ª–∏—á–Ω–æ |
| **–ü–ª–∞–≤–Ω–æ—Å—Ç—å** | 7/10 | ‚ö†Ô∏è –•–æ—Ä–æ—à–æ, –Ω—É–∂–Ω—ã —É–ª—É—á—à–µ–Ω–∏—è |
| **–ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è** | 9/10 | ‚úÖ –û—Ç–ª–∏—á–Ω–æ |
| **–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ** | 7/10 | ‚ö†Ô∏è –ù—É–∂–Ω—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ |
| **–ü–∞–º—è—Ç—å** | 8/10 | ‚úÖ –•–æ—Ä–æ—à–æ |
| **Android –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è** | 9/10 | ‚úÖ –û—Ç–ª–∏—á–Ω–æ |

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (Current State)

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   TikTokStyleFeed (UI Layer)            ‚îÇ
‚îÇ   - LegendList (signal-based)           ‚îÇ
‚îÇ   - ViewabilityConfig (50%, 100ms)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   EngineVideoPlayer (Integration)       ‚îÇ
‚îÇ   - useVideoEngine hook                 ‚îÇ
‚îÇ   - Event subscriptions                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   VideoEngine360V4 (Brain)              ‚îÇ
‚îÇ   - Index-oriented control              ‚îÇ
‚îÇ   - Event emitter (no polling!)         ‚îÇ
‚îÇ   - Scroll direction tracking           ‚îÇ
‚îÇ   - Global AppState                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   PreloadManager (Intelligent)          ‚îÇ
‚îÇ   - Direction-aware prefetch            ‚îÇ
‚îÇ   - HLS manifest + segment preload      ‚îÇ
‚îÇ   - Network-aware (WiFi/Cellular)       ‚îÇ
‚îÇ   - Priority queue                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## ‚úÖ –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã

### 1. –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ (8/10) - **–û–¢–õ–ò–ß–ù–û**

#### PreloadManager
```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: Direction-aware preloading
if (scrollDirection === 'down') {
  preloadIndices = [current, current+1, current+2, current-1];
} else {
  preloadIndices = [current, current-1, current-2, current+1];
}
```

**–ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- ‚úÖ –£–º–Ω–∞—è –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —Å —É—á–µ—Ç–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∫—Ä–æ–ª–ª–∞
- ‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è (high/medium/low)
- ‚úÖ Network-aware (WiFi vs Cellular)
- ‚úÖ GET with Range –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è —Å–µ–≥–º–µ–Ω—Ç–æ–≤
- ‚úÖ –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ Concurrency limit (max 3 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö)

**–ú–µ—Ç—Ä–∏–∫–∏:**
- Preload window: 2-3 –≤–∏–¥–µ–æ –≤–ø–µ—Ä–µ–¥
- Segment preload: 100KB –ø–µ—Ä–≤–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞
- Cache TTL: 5 –º–∏–Ω—É—Ç
- Max cache: 10 –≤–∏–¥–µ–æ

### 2. VideoEngine360V4 (9/10) - **–û–¢–õ–ò–ß–ù–û**

**–ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- ‚úÖ Event-driven –≤–º–µ—Å—Ç–æ polling (–±–∞—Ç—á–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —ç–º–∏—Ç—ã)
- ‚úÖ Global AppState listener (–Ω–µ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –∫–∞–∂–¥–æ–º –≤–∏–¥–µ–æ)
- ‚úÖ Index-oriented control
- ‚úÖ Retry logic —Å exponential backoff
- ‚úÖ Android surface error detection
- ‚úÖ Memory management (cleanup distant videos)

```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: Event batching —Å microtasks
private scheduleEmit(): void {
  queueMicrotask(() => {
    const toEmit = Array.from(this.pendingEmits);
    this.pendingEmits.clear();
    for (const id of toEmit) {
      listeners.forEach(cb => cb(state));
    }
  });
}
```

### 3. Android –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (9/10) - **–û–¢–õ–ò–ß–ù–û**

```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: Android guards
if (Platform.OS === 'android' && !player.play) {
  appLogger.warn('Android surface lost');
  return; // –ù–µ –ø—ã—Ç–∞–µ–º—Å—è play –Ω–∞ broken player
}

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: Warm-up –¥–ª—è cold start
if (Platform.OS === 'android') {
  preloadManager.warmUp(activeState.url);
}
```

**Android-specific –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
- Surface error detection –∏ recovery
- –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π bufferTimeMs (1000ms vs 800ms –Ω–∞ iOS)
- 4 retry –≤–º–µ—Å—Ç–æ 3 (Android –º–µ–Ω–µ–µ —Å—Ç–∞–±–∏–ª–µ–Ω)
- Warm-up –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –≤–∏–¥–µ–æ

### 4. Memory Management (8/10) - **–•–û–†–û–®–û**

```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: Cleanup —Å requestIdleCallback
const toRemove = outsideWindow.slice(0, toRemoveCount);
requestIdleCallback(() => {
  for (const id of toRemove) {
    videoStates.delete(id);
  }
});
```

---

## ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã –∏ —É–∑–∫–∏–µ –º–µ—Å—Ç–∞

### 1. –ü–ª–∞–≤–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è (7/10) - **–ù–£–ñ–ù–´ –£–õ–£–ß–®–ï–ù–ò–Ø**

#### –ü—Ä–æ–±–ª–µ–º–∞ 1.1: –ó–∞–¥–µ—Ä–∂–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
```typescript
// ‚ùå –ü–†–û–ë–õ–ï–ú–ê: –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ 800-1000ms
const timer = setTimeout(() => {
  this.play(id);
}, this.config.bufferTimeMs); // 800-1000ms
```

**–í–ª–∏—è–Ω–∏–µ:**
- –í–∏–¥–∏–º–∞—è –ø–∞—É–∑–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ (–¥–æ 1 —Å–µ–∫—É–Ω–¥—ã)
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —á–µ—Ä–Ω—ã–π —ç–∫—Ä–∞–Ω –∏–ª–∏ poster
- TikTok –Ω–∞—á–∏–Ω–∞–µ—Ç –∏–≥—Ä–∞—Ç—å –º–≥–Ω–æ–≤–µ–Ω–Ω–æ

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// ‚úÖ –£–õ–£–ß–®–ï–ù–ò–ï: –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
const getAdaptiveBufferTime = (state: VideoState) => {
  if (state.isPreloaded) return 100; // –£–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ
  if (preloadManager.isPreloaded(id)) return 200; // –°–µ–≥–º–µ–Ω—Ç—ã –≤ –∫–µ—à–µ
  return Platform.OS === 'ios' ? 500 : 700; // –•–æ–ª–æ–¥–Ω—ã–π —Å—Ç–∞—Ä—Ç
};
```

#### –ü—Ä–æ–±–ª–µ–º–∞ 1.2: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–ª–∞–≤–Ω–æ–≥–æ fade
```typescript
// ‚ùå –ü–†–û–ë–õ–ï–ú–ê: –†–µ–∑–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ poster -> video
{posterUrl && !engineState?.isPlaying && (
  <Image source={{ uri: posterUrl }} />
)}
```

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// ‚úÖ –£–õ–£–ß–®–ï–ù–ò–ï: –ü–ª–∞–≤–Ω—ã–π crossfade
<Animated.View style={{ opacity: posterOpacity }}>
  <Image source={{ uri: posterUrl }} />
</Animated.View>
```

### 2. Preload –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ—Å—Ç—å (7/10) - **–ú–û–ñ–ù–û –õ–£–ß–®–ï**

#### –ü—Ä–æ–±–ª–µ–º–∞ 2.1: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ WiFi
```typescript
// ‚ùå –ü–†–û–ë–õ–ï–ú–ê: –¢–æ–ª—å–∫–æ 3 –≤–∏–¥–µ–æ –≤–ø–µ—Ä–µ–¥ –Ω–∞ WiFi
if (this.isWiFi) {
  preloadIndices.push(currentIndex + 3); // –í—Å–µ–≥–æ 1 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ
}
```

**TikTok –∑–∞–≥—Ä—É–∂–∞–µ—Ç:**
- WiFi: 5-7 –≤–∏–¥–µ–æ –≤–ø–µ—Ä–µ–¥
- Cellular: 2-3 –≤–∏–¥–µ–æ

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// ‚úÖ –£–õ–£–ß–®–ï–ù–ò–ï: Aggressive preload –Ω–∞ WiFi
const PRELOAD_AHEAD = this.isWiFi ?
  { high: 3, medium: 2, low: 2 } : // WiFi: 7 total
  { high: 2, medium: 1, low: 0 };  // Cellular: 3 total
```

#### –ü—Ä–æ–±–ª–µ–º–∞ 2.2: –¢–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–π —Å–µ–≥–º–µ–Ω—Ç
```typescript
// ‚ùå –ü–†–û–ë–õ–ï–ú–ê: –¢–æ–ª—å–∫–æ 100KB –ø–µ—Ä–≤–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞
headers: { 'Range': `bytes=0-102400` }
```

**TikTok –ø–æ–¥—Ö–æ–¥:**
- –ü–µ—Ä–≤—ã–µ 2-3 —Å–µ–≥–º–µ–Ω—Ç–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é (–Ω–µ Range)
- ~500KB-1MB –¥–ª—è instant start

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// ‚úÖ –£–õ–£–ß–®–ï–ù–ò–ï: –ë–æ–ª—å—à–µ —Å–µ–≥–º–µ–Ω—Ç–æ–≤ –¥–ª—è high priority
if (priority === 'high') {
  const segmentsToPreload = this.isWiFi ? 3 : 2;
  for (let i = 0; i < segmentsToPreload && i < segments.length; i++) {
    await fetch(segments[i]); // –ü–æ–ª–Ω—ã–π —Å–µ–≥–º–µ–Ω—Ç, –Ω–µ Range
  }
}
```

### 3. Scroll velocity tracking (0/10) - **–û–¢–°–£–¢–°–¢–í–£–ï–¢**

**TikTok –∏—Å–ø–æ–ª—å–∑—É–µ—Ç:**
- Velocity –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è intent (fast scroll = skip)
- –°–Ω–∏–∂–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–º —Å–∫—Ä–æ–ª–ª–µ
- –û—Ç–º–µ–Ω–∞ –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–ª–∏—Å—Ç–∞–ª–∏

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// ‚úÖ –£–õ–£–ß–®–ï–ù–ò–ï: Velocity tracking
class ScrollVelocityTracker {
  track(scrollY: number, timestamp: number) {
    const velocity = (scrollY - this.lastY) / (timestamp - this.lastT);

    if (velocity > FAST_SCROLL_THRESHOLD) {
      // –°–Ω–∏–∂–∞–µ–º –∫–∞—á–µ—Å—Ç–≤–æ, —É–º–µ–Ω—å—à–∞–µ–º preload
      return 'fast-scroll';
    }
    return 'normal';
  }
}
```

### 4. Quality adaptation (0/10) - **–û–¢–°–£–¢–°–¢–í–£–ï–¢**

**TikTok –ø–æ–¥—Ö–æ–¥:**
- Adaptive Bitrate Streaming (ABR)
- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –Ω–∞ –ª–µ—Ç—É
- –£—á–µ—Ç battery level

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// ‚úÖ –£–õ–£–ß–®–ï–ù–ò–ï: ABR logic
const selectQuality = (networkSpeed: number, batteryLevel: number) => {
  if (batteryLevel < 20) return '360p';
  if (networkSpeed > 5_000_000) return '1080p';
  if (networkSpeed > 2_000_000) return '720p';
  return '480p';
};
```

### 5. Metrics & Analytics (5/10) - **–ë–ê–ó–û–í–´–ï**

```typescript
// ‚ùå –ü–†–û–ë–õ–ï–ú–ê: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
videoAnalytics.trackPreload(videoId, success);
```

**TikTok —Å–æ–±–∏—Ä–∞–µ—Ç:**
- Time to first frame (TTFF)
- Stall rate
- Bitrate switches
- Buffer health
- User engagement per video

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// ‚úÖ –£–õ–£–ß–®–ï–ù–ò–ï: –î–µ—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
interface VideoMetrics {
  ttff: number; // Time to first frame
  stallCount: number;
  stallDuration: number;
  avgBitrate: number;
  bufferHealth: number;
  watchTime: number;
  completionRate: number;
}
```

---

## üöÄ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é

### Priority 1: Instant Playback (Critical –¥–ª—è TikTok UX)

#### 1.1 –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π BufferTime
```typescript
// lib/video/videoEngine.ts

interface AdaptiveConfig {
  coldStart: number;
  warmStart: number;
  hotStart: number;
}

const ADAPTIVE_BUFFER: AdaptiveConfig = {
  coldStart: Platform.OS === 'ios' ? 500 : 700,
  warmStart: 200,
  hotStart: 50,
};

private getBufferTime(state: VideoState): number {
  // Hot: –≤–∏–¥–µ–æ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –≤ –∫–µ—à
  if (preloadManager.isPreloaded(state.id)) {
    return ADAPTIVE_BUFFER.hotStart; // 50ms
  }

  // Warm: –≤–∏–¥–µ–æ –±—ã–ª–æ –Ω–µ–¥–∞–≤–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ
  const recent = this.recentlyViewed.has(state.id);
  if (recent) {
    return ADAPTIVE_BUFFER.warmStart; // 200ms
  }

  // Cold: –ø–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
  return ADAPTIVE_BUFFER.coldStart; // 500-700ms
}
```

#### 1.2 –ü–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã
```typescript
// components/VideoFeed/EngineVideoPlayer.tsx

import { useSharedValue, withTiming } from 'react-native-reanimated';

const posterOpacity = useSharedValue(1);
const videoOpacity = useSharedValue(0);

useEffect(() => {
  if (engineState?.isPlaying) {
    // Crossfade: poster fade out, video fade in
    posterOpacity.value = withTiming(0, { duration: 300 });
    videoOpacity.value = withTiming(1, { duration: 300 });
  }
}, [engineState?.isPlaying]);
```

### Priority 2: Aggressive Preloading (WiFi)

#### 2.1 Expanded Preload Window
```typescript
// lib/video/preloadManager.ts

private getPreloadWindow(): { ahead: number; behind: number } {
  const connection = this.getConnectionType();

  if (connection === 'wifi') {
    return {
      ahead: 5,  // TikTok: 5-7 –≤–ø–µ—Ä–µ–¥
      behind: 2,
    };
  }

  if (connection === '4g') {
    return {
      ahead: 3,
      behind: 1,
    };
  }

  // 3G or slower
  return {
    ahead: 1,
    behind: 0,
  };
}
```

#### 2.2 Full Segment Preload
```typescript
// lib/video/preloadManager.ts

private async preloadSegments(
  segments: string[],
  priority: 'high' | 'medium' | 'low'
): Promise<void> {
  const segmentsToLoad = this.getSegmentCount(priority);

  for (let i = 0; i < segmentsToLoad && i < segments.length; i++) {
    try {
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –ü–û–õ–ù–´–ô —Å–µ–≥–º–µ–Ω—Ç (–Ω–µ Range)
      const response = await fetch(segments[i], {
        method: 'GET', // –ë–µ–∑ Range!
        cache: 'force-cache',
      });

      // –ß–∏—Ç–∞–µ–º –≤ –ø–∞–º—è—Ç—å –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
      await response.arrayBuffer();

      appLogger.debug(`[PreloadManager] Segment ${i} cached`);
    } catch (error) {
      // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø—Ä–∏ –æ—à–∏–±–∫–µ
      appLogger.warn(`[PreloadManager] Segment ${i} failed`, { error });
    }
  }
}

private getSegmentCount(priority: 'high' | 'medium' | 'low'): number {
  if (!this.isWiFi) {
    return priority === 'high' ? 2 : 1;
  }

  // WiFi: –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ
  return {
    high: 4,   // –ü–µ—Ä–≤—ã–µ 4 —Å–µ–≥–º–µ–Ω—Ç–∞
    medium: 2,
    low: 1,
  }[priority];
}
```

### Priority 3: Scroll Velocity Optimization

#### 3.1 Velocity Tracker
```typescript
// lib/video/scrollVelocityTracker.ts

export class ScrollVelocityTracker {
  private history: Array<{ y: number; t: number }> = [];
  private readonly MAX_HISTORY = 5;
  private readonly FAST_THRESHOLD = 3000; // px/s

  track(scrollY: number): {
    velocity: number;
    isFast: boolean;
    direction: 'up' | 'down' | 'none';
  } {
    const now = Date.now();

    this.history.push({ y: scrollY, t: now });
    if (this.history.length > this.MAX_HISTORY) {
      this.history.shift();
    }

    if (this.history.length < 2) {
      return { velocity: 0, isFast: false, direction: 'none' };
    }

    // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω—é—é —Å–∫–æ—Ä–æ—Å—Ç—å
    const first = this.history[0];
    const last = this.history[this.history.length - 1];

    const deltaY = last.y - first.y;
    const deltaT = last.t - first.t;

    const velocity = Math.abs(deltaY / deltaT) * 1000; // px/s
    const isFast = velocity > this.FAST_THRESHOLD;
    const direction = deltaY > 0 ? 'down' : deltaY < 0 ? 'up' : 'none';

    return { velocity, isFast, direction };
  }
}
```

#### 3.2 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ VideoEngine
```typescript
// lib/video/videoEngine.ts

private velocityTracker = new ScrollVelocityTracker();

setActiveIndex(index: number, scrollY?: number): void {
  // Track velocity
  const { velocity, isFast } = scrollY !== undefined
    ? this.velocityTracker.track(scrollY)
    : { velocity: 0, isFast: false };

  // Fast scroll: —É–º–µ–Ω—å—à–∞–µ–º preload, —Å–Ω–∏–∂–∞–µ–º –∫–∞—á–µ—Å—Ç–≤–æ
  if (isFast) {
    this.config.preloadAhead = 1; // –¢–æ–ª—å–∫–æ —Å–ª–µ–¥—É—é—â–µ–µ
    appLogger.debug('[VideoEngine] Fast scroll detected', { velocity });
  } else {
    this.config.preloadAhead = this.isWiFi ? 5 : 3; // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
  }

  // ... rest of logic
}
```

### Priority 4: Quality Adaptation (ABR)

#### 4.1 Network Speed Monitor
```typescript
// lib/video/networkMonitor.ts

export class NetworkSpeedMonitor {
  private speeds: number[] = [];

  async measureSpeed(): Promise<number> {
    const testUrl = 'https://your-cdn.com/test-1mb.bin';
    const startTime = Date.now();

    try {
      const response = await fetch(testUrl);
      await response.arrayBuffer();

      const duration = Date.now() - startTime;
      const sizeBytes = 1024 * 1024; // 1MB
      const speedBps = (sizeBytes * 8) / (duration / 1000);

      this.speeds.push(speedBps);
      if (this.speeds.length > 10) {
        this.speeds.shift();
      }

      // –°—Ä–µ–¥–Ω–µ–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∏–∑–º–µ—Ä–µ–Ω–∏–π
      return this.speeds.reduce((a, b) => a + b, 0) / this.speeds.length;
    } catch {
      return 0;
    }
  }

  getAverageSpeed(): number {
    if (this.speeds.length === 0) return 0;
    return this.speeds.reduce((a, b) => a + b, 0) / this.speeds.length;
  }
}
```

#### 4.2 Quality Selector
```typescript
// lib/video/qualitySelector.ts

interface QualityLevel {
  name: string;
  width: number;
  height: number;
  bitrate: number;
}

const QUALITIES: QualityLevel[] = [
  { name: '1080p', width: 1920, height: 1080, bitrate: 5_000_000 },
  { name: '720p', width: 1280, height: 720, bitrate: 2_500_000 },
  { name: '480p', width: 854, height: 480, bitrate: 1_000_000 },
  { name: '360p', width: 640, height: 360, bitrate: 500_000 },
];

export class QualitySelector {
  selectQuality(
    networkSpeed: number,
    batteryLevel: number,
    isWiFi: boolean
  ): QualityLevel {
    // Battery saver mode
    if (batteryLevel < 20) {
      return QUALITIES[3]; // 360p
    }

    // Network-based selection
    if (!isWiFi) {
      // Cellular: –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ
      if (networkSpeed > 3_000_000) return QUALITIES[2]; // 480p
      return QUALITIES[3]; // 360p
    }

    // WiFi: –º–∞–∫—Å–∏–º—É–º
    if (networkSpeed > 6_000_000) return QUALITIES[0]; // 1080p
    if (networkSpeed > 3_000_000) return QUALITIES[1]; // 720p
    if (networkSpeed > 1_500_000) return QUALITIES[2]; // 480p
    return QUALITIES[3]; // 360p
  }
}
```

### Priority 5: Advanced Metrics

#### 5.1 Video Metrics Tracker
```typescript
// services/videoMetrics.ts

export class VideoMetricsTracker {
  private metrics = new Map<string, VideoMetrics>();

  startTracking(videoId: string): void {
    this.metrics.set(videoId, {
      videoId,
      loadStart: Date.now(),
      firstFrameTime: null,
      stallCount: 0,
      totalStallDuration: 0,
      watchTime: 0,
      bufferHealth: 100,
    });
  }

  recordFirstFrame(videoId: string): void {
    const m = this.metrics.get(videoId);
    if (!m || m.firstFrameTime) return;

    m.firstFrameTime = Date.now() - m.loadStart;
    appLogger.info('[Metrics] TTFF', {
      videoId,
      ttff: m.firstFrameTime
    });
  }

  recordStall(videoId: string, duration: number): void {
    const m = this.metrics.get(videoId);
    if (!m) return;

    m.stallCount++;
    m.totalStallDuration += duration;
    appLogger.warn('[Metrics] Stall', {
      videoId,
      duration,
      totalStalls: m.stallCount
    });
  }

  getMetrics(videoId: string): VideoMetrics | null {
    return this.metrics.get(videoId) || null;
  }
}

export const videoMetrics = new VideoMetricsTracker();
```

---

## üìà –û–∂–∏–¥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

| –ú–µ—Ç—Ä–∏–∫–∞ | –°–µ–π—á–∞—Å | –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | TikTok |
|---------|--------|-------------------|--------|
| **Time to First Frame** | 800-1200ms | 50-300ms | 50-200ms |
| **Stall rate** | ~5% | <1% | <0.5% |
| **Preload hit rate** | ~70% | ~95% | ~98% |
| **Smooth transitions** | 60% | 95% | 98% |
| **Memory usage** | 150MB | 120MB | 100MB |
| **Battery impact** | Medium | Low | Low |

---

## üéØ Implementation Plan

### Phase 1: Quick Wins (1-2 –¥–Ω—è)
1. ‚úÖ –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π bufferTime (50/200/700ms)
2. ‚úÖ –ü–ª–∞–≤–Ω—ã–µ crossfade –ø–µ—Ä–µ—Ö–æ–¥—ã
3. ‚úÖ –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π preload window –Ω–∞ WiFi (5 –≤–ø–µ—Ä–µ–¥)

### Phase 2: Core Improvements (3-5 –¥–Ω–µ–π)
4. ‚úÖ Full segment preload (–Ω–µ Range)
5. ‚úÖ Scroll velocity tracking
6. ‚úÖ Quality adaptation (ABR)

### Phase 3: Advanced (5-7 –¥–Ω–µ–π)
7. ‚úÖ –î–µ—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (TTFF, stall rate)
8. ‚úÖ ML-based prediction (next video intent)
9. ‚úÖ Battery optimization

---

## üí° TikTok-level Features

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∏—á–∏ –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è TikTok —É—Ä–æ–≤–Ω—è:

1. **Predictive Preloading**
   - ML –º–æ–¥–µ–ª—å –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–∏–¥–µ–æ
   - User behavior analysis
   - Category preferences

2. **Progressive Quality**
   - –ù–∞—á–∏–Ω–∞–µ–º —Å –Ω–∏–∑–∫–æ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞
   - Upgrade –Ω–∞ –ª–µ—Ç—É –¥–æ high quality
   - Seamless transitions

3. **Smart Caching**
   - LRU cache —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏
   - –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–π –∫–µ—à –Ω–∞ –¥–∏—Å–∫–µ
   - Background sync

4. **Performance Monitoring**
   - Real-time dashboards
   - Alert –Ω–∞ high stall rate
   - A/B testing framework

---

## üîß Quick Fixes (–º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Å–µ–π—á–∞—Å)

### 1. –£–º–µ–Ω—å—à–∏—Ç—å buffer delay –¥–ª—è preloaded –≤–∏–¥–µ–æ

**–§–∞–π–ª:** `lib/video/videoEngine.ts:434`

```typescript
// –ë–´–õ–û:
const timer = setTimeout(() => {
  this.play(id);
}, this.config.bufferTimeMs); // –í—Å–µ–≥–¥–∞ 800-1000ms

// –°–¢–ê–ù–ï–¢:
const bufferTime = preloadManager.isPreloaded(id)
  ? 100  // –í–∏–¥–µ–æ —É–∂–µ –≤ –∫–µ—à–µ - –∏–≥—Ä–∞–µ–º –ø–æ—á—Ç–∏ —Å—Ä–∞–∑—É
  : this.config.bufferTimeMs;

const timer = setTimeout(() => {
  this.play(id);
}, bufferTime);
```

### 2. –£–≤–µ–ª–∏—á–∏—Ç—å preload window –Ω–∞ WiFi

**–§–∞–π–ª:** `lib/video/videoEngine.ts:49-77`

```typescript
// –ë–´–õ–û:
if (Platform.OS === 'ios') {
  config.preloadAhead = 3;
}

// –°–¢–ê–ù–ï–¢:
if (Platform.OS === 'ios') {
  config.preloadAhead = this.isWiFi ? 5 : 3; // WiFi: –±–æ–ª—å—à–µ
}
```

### 3. Preload –ø–æ–ª–Ω—ã—Ö —Å–µ–≥–º–µ–Ω—Ç–æ–≤ –¥–ª—è high priority

**–§–∞–π–ª:** `lib/video/preloadManager.ts:265-283`

```typescript
// –ë–´–õ–û:
headers: { 'Range': `bytes=0-${PRELOAD_CONFIG.SEGMENT_PRELOAD_BYTES}` }

// –°–¢–ê–ù–ï–¢:
// –î–ª—è high priority - –≥—Ä—É–∑–∏–º –ø–æ–ª–Ω–æ—Å—Ç—å—é
if (priority === 'high') {
  await fetch(segments[0], { method: 'GET' });
} else {
  await fetch(segments[0], {
    method: 'GET',
    headers: { 'Range': `bytes=0-${PRELOAD_CONFIG.SEGMENT_PRELOAD_BYTES}` }
  });
}
```

---

## ‚úÖ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

### –¢–µ–∫—É—â–∏–π –¥–≤–∏–∂–æ–∫: **Solid Foundation (85/100)**

–í–∞—à –≤–∏–¥–µ–æ–¥–≤–∏–∂–æ–∫ —É–∂–µ –Ω–∞ **–æ—á–µ–Ω—å —Ö–æ—Ä–æ—à–µ–º —É—Ä–æ–≤–Ω–µ**:
- ‚úÖ Event-driven architecture
- ‚úÖ Intelligent preloading
- ‚úÖ Android optimizations
- ‚úÖ Memory management

### –î–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è TikTok —É—Ä–æ–≤–Ω—è –Ω—É–∂–Ω–æ:

1. **Instant playback** (50-200ms TTFF)
2. **Aggressive preloading** (5-7 –≤–∏–¥–µ–æ –Ω–∞ WiFi)
3. **Smooth transitions** (crossfade)
4. **Adaptive quality** (ABR based on network)
5. **Advanced metrics** (TTFF, stall rate tracking)

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã:

**üî• Must Have (Phase 1):**
- –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π bufferTime
- –ü–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã
- Expanded preload window

**‚ö° Should Have (Phase 2):**
- Full segment preload
- Velocity tracking
- Quality adaptation

**üíé Nice to Have (Phase 3):**
- ML predictions
- Progressive quality
- Advanced analytics

---

**–ì–æ—Ç–æ–≤ –ø—Ä–∏—Å—Ç—É–ø–∏—Ç—å –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏?** üöÄ
