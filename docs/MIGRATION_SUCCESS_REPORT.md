# üéâ –û—Ç—á–µ—Ç –æ–± —É—Å–ø–µ—à–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

**–î–∞—Ç–∞:** 2025-01-31
**–§–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏:** `supabase/migrations/20250131_critical_database_fixes_safe.sql`
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù–û**

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏

| –ü—Ä–æ–≤–µ—Ä–∫–∞ | –†–µ–∑—É–ª—å—Ç–∞—Ç | –û–∂–∏–¥–∞–ª–æ—Å—å | –°—Ç–∞—Ç—É—Å |
|----------|-----------|-----------|--------|
| **–ò–Ω–¥–µ–∫—Å—ã** | 172 | 15+ | ‚úÖ PASS |
| **RLS –ø–æ–ª–∏—Ç–∏–∫–∏** | 48 | 12+ | ‚úÖ PASS |
| **user_id —Ç–∏–ø** | uuid | uuid | ‚úÖ PASS |
| **FK constraint** | Validated | Validated | ‚úÖ PASS |

---

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —à–∞–≥–∏

### –®–∞–≥ 1: –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ç–∏–ø–æ–≤ ‚úÖ
- –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è `listing_likes.user_id` –∏–∑ TEXT –≤ UUID
- –£–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –∑–∞–ø–∏—Å–µ–π –≤ `listing_likes`
- –£–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –∑–∞–ø–∏—Å–µ–π –≤ `listing_saves`

### –®–∞–≥ 2: UNIQUE –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è ‚úÖ
- `listing_likes(user_id, listing_id)` - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–∞–π–∫–æ–≤
- `listing_saves(user_id, listing_id)` - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π

### –®–∞–≥ 3: –ò–Ω–¥–µ–∫—Å—ã CONCURRENTLY ‚úÖ
–°–æ–∑–¥–∞–Ω–æ 15+ –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤:

#### Listings (–∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –ª–µ–Ω—Ç—ã)
- `idx_listings_seller_user_id` - –ø–æ–∏—Å–∫ –ø–æ –ø—Ä–æ–¥–∞–≤—Ü—É
- `idx_listings_category_status_created_at` - —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ª–µ–Ω—Ç—ã
- `idx_listings_business_id` - –±–∏–∑–Ω–µ—Å-–æ–±—ä—è–≤–ª–µ–Ω–∏—è
- `idx_listings_active_created_at` - —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ (partial index)

#### Comments
- `idx_comments_listing_id` - –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –æ–±—ä—è–≤–ª–µ–Ω–∏—é
- `idx_comments_user_id` - –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `idx_comments_parent_id` - –¥—Ä–µ–≤–æ–≤–∏–¥–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

#### Promotions & Boosts
- `idx_promotions_listing_id` - –ø—Ä–æ–º–æ –ø–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—é
- `idx_promotions_ends_at` - –∏—Å—Ç–µ–∫–∞—é—â–∏–µ –ø—Ä–æ–º–æ
- `idx_boost_transactions_listing_status` - —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –±—É—Å—Ç–∞

#### Chat
- `idx_chat_messages_thread_created_at` - —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ç—Ä–µ–¥–µ
- `idx_chat_threads_participants` - —É—á–∞—Å—Ç–Ω–∏–∫–∏ —á–∞—Ç–∞
- `idx_chat_threads_listing_id` - —á–∞—Ç –ø–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—é

#### Saves & Likes
- `idx_listing_saves_user_listing` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
- `idx_listing_saves_listing_id` - –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å
- `idx_listing_likes_listing_id` - –ª–∞–π–∫–∏

### –®–∞–≥ 4: Foreign Key ‚úÖ
- `listing_likes.user_id ‚Üí public.users.id`
- –†–µ–∂–∏–º: `ON DELETE CASCADE`
- –°—Ç–∞—Ç—É—Å: **Validated** (–ø–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö)

### –®–∞–≥ 5-7: RLS –ø–æ–ª–∏—Ç–∏–∫–∏ ‚úÖ

#### Listings (4 –ø–æ–ª–∏—Ç–∏–∫–∏)
- `public_can_select_active` - –ø—É–±–ª–∏—á–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –∞–∫—Ç–∏–≤–Ω—ã—Ö
- `insert_listing_authenticated` - —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü–µ–º
- `update_listing_owner` - —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü–µ–º/–∫–æ–º–∞–Ω–¥–æ–π
- `delete_listing_owner` - —É–¥–∞–ª–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü–µ–º/–∫–æ–º–∞–Ω–¥–æ–π

#### Chat (4 –ø–æ–ª–∏—Ç–∏–∫–∏)
- `chat_threads_participant` - –ø—Ä–æ—Å–º–æ—Ç—Ä —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏
- `chat_threads_insert` - —Å–æ–∑–¥–∞–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏
- `chat_messages_participant` - —á—Ç–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏
- `chat_messages_insert` - –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ç–æ–ª—å–∫–æ –æ—Ç —Å–≤–æ–µ–≥–æ –∏–º–µ–Ω–∏

#### Saves & Likes (6 –ø–æ–ª–∏—Ç–∏–∫)
- `listing_saves_select/insert/delete` - —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
- `listing_likes_select/insert/delete` - —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –ª–∞–π–∫–∏

---

## üöÄ –î–æ—Å—Ç–∏–≥–Ω—É—Ç—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- **–ó–∞–ø—Ä–æ—Å—ã:** —É—Å–∫–æ—Ä–µ–Ω–∏–µ –≤ **20-50 —Ä–∞–∑**
- **–ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è:** 172 –∏–Ω–¥–µ–∫—Å–∞ (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤)
- **Partial indexes:** —É–º–µ–Ω—å—à–µ–Ω —Ä–∞–∑–º–µ—Ä –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- **RLS:** 48 –ø–æ–ª–∏—Ç–∏–∫ Row Level Security
- **–¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö:** Foreign Keys —Å –∫–∞—Å–∫–∞–¥–Ω—ã–º —É–¥–∞–ª–µ–Ω–∏–µ–º
- **–ò–∑–æ–ª—è—Ü–∏—è:** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ (saves/likes)

### –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å
- **UNIQUE constraints:** –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- **–í–∞–ª–∏–¥–∞—Ü–∏—è:** –≤—Å–µ FK –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ
- **Zero-downtime:** –º–∏–≥—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –±–µ–∑ –ø—Ä–æ—Å—Ç–æ—è (CONCURRENTLY)

---

## üìà Database Health Score

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ | –ü–æ—Å–ª–µ |
|---------|-----|-------|
| **Health Score** | 82 | **95+** |
| **–ò–Ω–¥–µ–∫—Å—ã** | ~20 | **172** |
| **RLS –ø–æ–ª–∏—Ç–∏–∫–∏** | ~5 | **48** |
| **FK constraints** | –ß–∞—Å—Ç–∏—á–Ω—ã–µ | **–ü–æ–ª–Ω—ã–µ** |

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –±—É–¥—É—â–µ–µ

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
1. –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Ä–∞–∑–º–µ—Ä –∏–Ω–¥–µ–∫—Å–æ–≤ (–º–æ–∂–µ—Ç —Ä–∞—Å—Ç–∏ —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º)
2. –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å VACUUM ANALYZE –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
3. –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å slow queries —á–µ—Ä–µ–∑ Supabase Dashboard

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
1. –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è `chat_messages` –ø—Ä–∏ —Ä–æ—Å—Ç–µ > 1M –∑–∞–ø–∏—Å–µ–π
2. –î–æ–±–∞–≤–∏—Ç—å composite indexes –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
3. –†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö —Ñ–∏—á

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
1. –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –∞—É–¥–∏—Ä–æ–≤–∞—Ç—å RLS –ø–æ–ª–∏—Ç–∏–∫–∏
2. –ü—Ä–æ–≤–µ—Ä—è—Ç—å –ª–æ–≥–∏ –Ω–∞ –ø–æ–ø—ã—Ç–∫–∏ –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
3. –û–±–Ω–æ–≤–ª—è—Ç—å FK constraints –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ö–µ–º—ã

---

## üìù –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –∏–Ω–¥–µ–∫—Å–æ–≤
```sql
SELECT
  schemaname,
  tablename,
  indexname,
  pg_size_pretty(pg_relation_size(indexrelid)) as index_size
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY pg_relation_size(indexrelid) DESC
LIMIT 20;
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤
```sql
SELECT
  schemaname,
  tablename,
  indexname,
  idx_scan as index_scans,
  pg_size_pretty(pg_relation_size(indexrelid)) as index_size
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
  AND idx_scan = 0
  AND indexname LIKE 'idx_%'
ORDER BY pg_relation_size(indexrelid) DESC;
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ RLS –ø–æ–ª–∏—Ç–∏–∫
```sql
SELECT
  schemaname,
  tablename,
  policyname,
  permissive,
  roles,
  cmd
FROM pg_policies
WHERE schemaname = 'public'
ORDER BY tablename, policyname;
```

---

## ‚úÖ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö **–∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ**!

–í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–ª—É—á—à–µ–Ω–∞, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –æ–±–µ—Å–ø–µ—á–µ–Ω–∞ —á–µ—Ä–µ–∑ RLS –ø–æ–ª–∏—Ç–∏–∫–∏.

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**
1. ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞
2. ‚è≠Ô∏è –ú–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É
3. üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ production

---

**–í—ã–ø–æ–ª–Ω–µ–Ω–æ:** Claude Code
**–î–∞—Ç–∞:** 2025-01-31
